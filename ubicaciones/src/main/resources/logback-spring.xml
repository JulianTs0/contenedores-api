<?xml version="1.0" encoding="UTF-8"?>
<configuration>

    <!--
    PASO 3: Persistencia Local y Rotación (Rolling Log)
    PASO 4: Inclusión del Correlation ID (MDC)
    -->

    <!-- Variable para definir la ruta de los logs -->
    <property name="LOG_PATH" value="logs" />

    <!--
    Patrón de Log:
    %d: Fecha y hora
    %-5level: Nivel de log (INFO, DEBUG, etc.)
    [%thread]: Hilo que ejecuta
    [%-40.40logger{39}]: Nombre de la clase (acortado)
    [%X{correlationId}]: <- ¡AQUÍ ESTÁ EL CORRELATION ID! Lee la clave "correlationId" del MDC.
    %msg%n: Mensaje de log y salto de línea
    -->
    <property name="LOG_PATTERN"
              value="%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%thread] [%-40.40logger{39}] [%X{correlationId}] : %msg%n" />

    <!-- 1. Appender de Consola (Salida Estándar) -->
    <!-- Esto cumple el requisito de "Configuración en Docker" (escribir en stdout) -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
            <charset>utf8</charset>
        </encoder>
    </appender>

    <!-- 2. Appender de Archivo con Rotación (Rolling File Appender) -->
    <!-- Esto cumple el requisito de "Persistencia Local y Rotación" -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/ubicaciones-service.log</file>

        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
            <charset>utf8</charset>
        </encoder>

        <!-- Política de Rotación: Rota diariamente O si el archivo supera los 10MB -->
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <!-- Patrón del archivo historico (diario) -->
            <fileNamePattern>${LOG_PATH}/archived/ubicaciones-service-%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <!-- Tamaño máximo del archivo antes de rotar (dentro del mismo día) -->
                <maxFileSize>10MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <!-- Mantener 30 días de historial -->
            <maxHistory>30</maxHistory>
        </rollingPolicy>
    </appender>

    <!--
    Configuración de Loggers:
    Define qué appenders usar y el nivel (leído desde application.yml)
    -->

    <!-- Logger Raíz: Usa ambos appenders (Consola y Archivo) -->
    <root level="INFO"> <!-- El nivel aquí es un fallback, el de .yml tiene prioridad -->
        <appender-ref ref="CONSOLE" />
        <appender-ref ref="FILE" />
    </root>

    <!-- Logger específico para nuestro paquete -->
    <!-- No es necesario re-definirlo si ya está en application.yml,
         pero sirve para asegurar que use los appenders correctos.
         'additivity=false' evita que los logs se dupliquen en el root. -->
    <logger name="backend.grupo130.ubicaciones" level="DEBUG" additivity="false">
        <appender-ref ref="CONSOLE" />
        <appender-ref ref="FILE" />
    </logger>

</configuration>
