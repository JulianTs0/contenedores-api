@startuml
title TramoService - registrarFinTramo

hide footbox

actor "Cliente/API" as C
control "TramoService" as TS
participant "TramoRepository" as TR
control "EnviosService" as ES
control "CamionService" as CMS
control "ContenedorService" as CS
control "UbicacionService" as UBS

C -> TS: registrarFinTramo(request)

activate TS

note right: Validar tramo existe, INICIADO, y pertenece al camion

TS -> TR: getById(idTramo)
activate TR
TR --> TS: tramo
deactivate TR

note right: Obtener ruta y solicitud

TS -> ES: getSolicitudTrasladoById(idSolicitud)
activate ES
ES --> TS: solicitud
deactivate ES

note right: Validar solicitud EN_TRANSITO

TS -> CMS: getById(dominio)
activate CMS
note right: Validar camion existe
CMS --> TS: camion
deactivate CMS

note right: Cambiar disponibilidad a true

TS -> CMS: cambiarDisponibilidad(true)
activate CMS
CMS --> TS: response
deactivate CMS

TS -> TR: update(tramo)
activate TR
deactivate TR

opt Fin en Depósito
    TS -> CS: getById(idContenedor)
    activate CS
    CS --> TS: contenedor
    deactivate CS

    TS -> CS: cambioDeEstado(en_deposito)
    activate CS
    CS --> TS: response
    deactivate CS
end

opt Ultimo Tramo
    TS -> CS: getById(idContenedor)
    activate CS
    CS --> TS: contenedor
    deactivate CS

    TS -> CS: cambioDeEstado(entregado)
    activate CS
    CS --> TS: response
    deactivate CS

    TS -> TR: buscarPorRuta(idRuta)
    activate TR
    TR --> TS: listaTramos
    deactivate TR
    
    loop Calcular costo estadías reales
        note right: Calcular días de estadía entre fin de tramo actual e inicio del siguiente
        TS -> UBS: getUbicacionById(idDestino)
        activate UBS
        note right: Obtener costo diario del depósito
        UBS --> TS: ubicacion
        deactivate UBS
    end
    
    TS -> ES: editSolicitud(costoFinal, tiempoReal)
    activate ES
    ES --> TS: response
    deactivate ES

    TS -> ES: cambioDeEstadoSolicitud(entregado)
    activate ES
    ES --> TS: response
    deactivate ES
end

deactivate TS
@enduml
