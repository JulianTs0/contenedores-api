@startuml
title RutaService - getRutaTentativa 

hide footbox

actor "Cliente/API" as C
control "RutaService" as RS
control "EnviosService" as ES
control "ContenedorService" as CS
control "UsuarioService" as US
control "CamionService" as CMS
participant "RutaRepository" as RR
participant "TramoRepository" as TR
control "UbicacionService" as UBS
participant "OsrmApiClient" as OSRM

C -> RS: getRutaTentativa(request)

activate RS

note right: Validar solicitud en BORRADOR

RS -> ES: getSolicitudTrasladoById(idSolicitud)
activate ES
ES --> RS: solicitud
deactivate ES

RS -> CS: getById(idContenedor)
activate CS
    opt idCliente != null
        note right: Validar rol CLIENTE
        CS -> US: getById(idCliente)
        activate US
        US --> CS: usuario
        deactivate US
    end
CS --> RS: contenedor
deactivate CS

RS -> ES: getUltimosPrecios()
activate ES
ES --> RS: preciosNegocio
deactivate ES

RS -> CMS: getPromedioCostoBase(peso, volumen)
activate CMS
CMS --> RS: costoBase
deactivate CMS

RS -> CMS: getConsumoPromedio()
activate CMS
CMS --> RS: consumoPromedio
deactivate CMS

RS -> RR: getBySolicitud(idSolicitud)
activate RR
RR --> RS: rutaExistente
deactivate RR

alt rutaExiste
    RS -> TR: deleteByRutaId(idRuta)
else nuevaRuta
    note right: Crear ruta con cargosGestionFijo
    RS -> RR: save(ruta)
    activate RR
    RR --> RS: rutaGuardada
    deactivate RR
end

RS -> UBS: getByListIds(ubicaciones)
activate UBS
UBS --> RS: listaUbicaciones
deactivate UBS

loop Para cada par de ubicaciones (orden 0 to size-2)
    note right: origen = ubicaciones[orden], destino = ubicaciones[orden+1]

    RS -> OSRM: calcularDistancia(origen, destino)
    activate OSRM
    OSRM --> RS: routeResponse
    deactivate OSRM

    note right: Calcular tramo con distancia, tiempo, estado ESTIMADO
end

RS -> TR: saveAll(tramos)
activate TR
TR --> RS: tramosGuardados
deactivate TR

note right: Calcular tarifa con costos base, consumo, estadÃ­as, distancia total

RS -> ES: editSolicitud(tiempoEstimadoHoras, tarifa)
activate ES
ES --> RS: response
deactivate ES

RS -> RR: update(ruta)
activate RR
RR --> RS: rutaActualizada
deactivate RR

RS --> C: response
deactivate RS
@enduml
