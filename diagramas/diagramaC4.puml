@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

' Configuración visual para mejorar la legibilidad
skinparam wrapWidth 200
skinparam maxMessageSize 150
LAYOUT_TOP_DOWN()
' LAYOUT_WITH_LEGEND()

title Diagrama de Contenedores C4 - Arquitectura Docker Compose

' --- INFRAESTRUCTURA COMPARTIDA ---
System_Boundary(infra_boundary, "Infraestructura & Seguridad") {
    Container(gateway, "API Gateway", "Java / Spring Cloud Gateway", "Punto de entrada único (Puerto 8082)", $tags="gateway")
    Container_Ext(keycloak, "Keycloak", "Docker Container", "Servidor IAM / Auth (Puerto 8081)")
}

System_Boundary(obs_boundary, "Observabilidad") {
    Container(grafana, "Grafana", "Docker Container", "Visualización (Puerto 3000)")
    Container(loki, "Loki", "Docker Container", "Agregación de logs (Puerto 3100)")
    Container(promtail, "Promtail", "Docker Container", "Recolección de logs")
}

' --- MICROSERVICIOS Y SUS BASES DE DATOS ---

System_Boundary(ms_usuarios_boundary, "Microservicio Usuarios") {
    Container(api_usuarios, "API Usuarios", "Java / Spring Boot", "Puerto 8090")
    ContainerDb(db_usuarios, "DB Usuarios", "PostgreSQL 16", "Puerto 6432")
}

System_Boundary(ms_contenedores_boundary, "Microservicio Contenedores") {
    Container(api_contenedores, "API Contenedores", "Java / Spring Boot", "Puerto 8091")
    ContainerDb(db_contenedores, "DB Contenedores", "PostgreSQL 16", "Puerto 6433")
}

System_Boundary(ms_tramos_boundary, "Microservicio Tramos") {
    Container(api_tramos, "API Tramos", "Java / Spring Boot", "Puerto 8092")
    ContainerDb(db_tramos, "DB Tramos", "PostgreSQL 16", "Puerto 6434")
}

System_Boundary(ms_camiones_boundary, "Microservicio Camiones") {
    Container(api_camiones, "API Camiones", "Java / Spring Boot", "Puerto 8093")
    ContainerDb(db_camiones, "DB Camiones", "PostgreSQL 16", "Puerto 6435")
}

System_Boundary(ms_ubicaciones_boundary, "Microservicio Ubicaciones") {
    Container(api_ubicaciones, "API Ubicaciones", "Java / Spring Boot", "Puerto 8094")
    ContainerDb(db_ubicaciones, "DB Ubicaciones", "PostgreSQL 16", "Puerto 6436")
}

System_Boundary(ms_envios_boundary, "Microservicio Envíos") {
    Container(api_envios, "API Envíos", "Java / Spring Boot", "Puerto 8095")
    ContainerDb(db_envios, "DB Envíos", "PostgreSQL 16", "Puerto 6437")
}

' --- RELACIONES ---

' 1. Gateway & Auth
Rel(gateway, keycloak, "Delega autenticación", "HTTP/OIDC")
Rel(gateway, api_usuarios, "Enruta", "HTTP")
Rel(gateway, api_contenedores, "Enruta", "HTTP")
Rel(gateway, api_tramos, "Enruta", "HTTP")
Rel(gateway, api_camiones, "Enruta", "HTTP")
Rel(gateway, api_ubicaciones, "Enruta", "HTTP")
Rel(gateway, api_envios, "Enruta", "HTTP")

' 2. Conexiones a BD (Internas)
Rel(api_usuarios, db_usuarios, "Lee/Escribe", "JDBC")
Rel(api_contenedores, db_contenedores, "Lee/Escribe", "JDBC")
Rel(api_tramos, db_tramos, "Lee/Escribe", "JDBC")
Rel(api_camiones, db_camiones, "Lee/Escribe", "JDBC")
Rel(api_ubicaciones, db_ubicaciones, "Lee/Escribe", "JDBC")
Rel(api_envios, db_envios, "Lee/Escribe", "JDBC")

' 3. Comunicaciones Inter-Servicios (Feign Clients)

' MS Contenedores -> Usuarios
Rel(api_contenedores, api_usuarios, "Valida cliente", "HTTP/JSON")

' MS Camiones -> Usuarios
Rel(api_camiones, api_usuarios, "Valida transportista", "HTTP/JSON")

' MS Tramos -> Todos (Complejo)
Rel(api_tramos, api_usuarios, "Consulta usuarios", "HTTP/JSON")
Rel(api_tramos, api_camiones, "Asigna camiones", "HTTP/JSON")
Rel(api_tramos, api_envios, "Actualiza estado envío", "HTTP/JSON")
Rel(api_tramos, api_ubicaciones, "Obtiene coordenadas", "HTTP/JSON")
Rel(api_tramos, api_contenedores, "Verifica carga", "HTTP/JSON")

' MS Envíos -> Todos (Complejo)
Rel(api_envios, api_usuarios, "Consulta cliente", "HTTP/JSON")
Rel(api_envios, api_camiones, "Consulta disponibilidad", "HTTP/JSON")
Rel(api_envios, api_tramos, "Solicita ruta", "HTTP/JSON")
Rel(api_envios, api_ubicaciones, "Valida origen/destino", "HTTP/JSON")
Rel(api_envios, api_contenedores, "Asigna contenedor", "HTTP/JSON")

' 4. Observabilidad
Rel(promtail, loki, "Envía logs", "HTTP")
Rel(grafana, loki, "Consulta", "HTTP")

@enduml
